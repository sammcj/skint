name: Build and Release

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

# cancel in progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  security-events: read

jobs:
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && !contains(github.event.head_commit.message, '[skip-ci]')
    outputs:
      new_tag: ${{ steps.tag_version.outputs.new_tag }}
      changelog: ${{ steps.tag_version.outputs.changelog }}
    permissions:
      contents: write
    steps:
      - name: Check out code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@d28fa2ccfbd16e871a4bdf35e11b3ad1bd56c0c1 # v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release_branches: main
          default_bump: patch
          tag_prefix: v
          create_annotated_tag: true

  build-linux-amd64:
    name: Build Linux AMD64
    runs-on: ubuntu-latest
    needs: [bump-version]
    if: always() && (needs.bump-version.result == 'success' || needs.bump-version.result == 'skipped') && !contains(github.event.head_commit.message, '[skip-ci]')
    steps:
      - name: Check out code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Extract Go version from go.mod
        id: go-version
        run: echo "version=$(grep '^go ' go.mod | awk '{print $2}')" >> "$GITHUB_OUTPUT"

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: ${{ steps.go-version.outputs.version }}
          check-latest: true

      - name: Set up Go cache
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-amd64-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-amd64-go-

      - name: Get dependencies
        run: go mod download

      - name: Test
        run: make test

      - name: Lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: latest

      - name: Build
        env:
          GOOS: linux
          GOARCH: amd64
        run: |
          VERSION=$(.github/scripts/get-version.sh "${{ github.ref }}" "${{ needs.bump-version.outputs.new_tag }}")
          echo "Building version: $VERSION for linux/amd64"
          mkdir -p bin
          go build -v -o "bin/skint" \
            -ldflags "-s -w -X main.version=$VERSION" \
            .

      - name: Upload build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: skint-linux-amd64
          path: bin/skint*
          retention-days: 7

  build-linux-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-latest
    needs: [bump-version]
    if: always() && (needs.bump-version.result == 'success' || needs.bump-version.result == 'skipped') && github.event_name != 'pull_request' && !contains(github.event.head_commit.message, '[skip-ci]')
    steps:
      - name: Check out code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Extract Go version from go.mod
        id: go-version
        run: echo "version=$(grep '^go ' go.mod | awk '{print $2}')" >> "$GITHUB_OUTPUT"

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: ${{ steps.go-version.outputs.version }}
          check-latest: true

      - name: Set up Go cache
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-arm64-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-arm64-go-

      - name: Get dependencies
        run: go mod download

      - name: Build
        env:
          GOOS: linux
          GOARCH: arm64
        run: |
          VERSION=$(.github/scripts/get-version.sh "${{ github.ref }}" "${{ needs.bump-version.outputs.new_tag }}")
          echo "Building version: $VERSION for linux/arm64"
          mkdir -p bin
          go build -v -o "bin/skint" \
            -ldflags "-s -w -X main.version=$VERSION" \
            .

      - name: Upload build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: skint-linux-arm64
          path: bin/skint*
          retention-days: 7

  build-darwin-arm64:
    name: Build macOS ARM64
    runs-on: macos-latest
    needs: [bump-version]
    if: always() && (needs.bump-version.result == 'success' || needs.bump-version.result == 'skipped') && github.event_name != 'pull_request' && !contains(github.event.head_commit.message, '[skip-ci]')
    steps:
      - name: Check out code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Extract Go version from go.mod
        id: go-version
        run: echo "version=$(grep '^go ' go.mod | awk '{print $2}')" >> "$GITHUB_OUTPUT"

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: ${{ steps.go-version.outputs.version }}
          check-latest: true

      - name: Set up Go cache
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-arm64-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-arm64-go-

      - name: Get dependencies
        run: go mod download

      - name: Test
        run: make test

      - name: Build
        env:
          GOOS: darwin
          GOARCH: arm64
        run: |
          VERSION=$(.github/scripts/get-version.sh "${{ github.ref }}" "${{ needs.bump-version.outputs.new_tag }}")
          echo "Building version: $VERSION for darwin/arm64"
          mkdir -p bin
          go build -v -o "bin/skint" \
            -ldflags "-s -w -X main.version=$VERSION" \
            .

      - name: Upload build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: skint-darwin-arm64
          path: bin/skint*
          retention-days: 7

  release:
    name: Create Release
    needs: [build-linux-amd64, build-linux-arm64, build-darwin-arm64, bump-version]
    if: always() && !cancelled() && (needs.build-linux-amd64.result == 'success' && needs.build-linux-arm64.result == 'success' && needs.build-darwin-arm64.result == 'success') && (startsWith(github.ref, 'refs/tags/v') || (github.ref == 'refs/heads/main' && needs.bump-version.outputs.new_tag != '')) && !contains(github.event.head_commit.message, '[skip-ci]')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check out code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: artifacts/
          pattern: skint-*

      - name: Prepare release binaries
        run: |
          mkdir -p release/
          cp artifacts/skint-linux-amd64/skint release/skint-linux-amd64
          cp artifacts/skint-linux-arm64/skint release/skint-linux-arm64
          cp artifacts/skint-darwin-arm64/skint release/skint-darwin-arm64
          chmod +x release/*
          ls -la release/

      - name: Get version
        id: get_version
        run: |
          VERSION=$(.github/scripts/get-version.sh "${{ github.ref }}" "${{ needs.bump-version.outputs.new_tag }}")
          echo "Using version: $VERSION"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Generate changelog
        id: changelog
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ needs.bump-version.outputs.changelog }}" != "" ]]; then
            CHANGELOG="${{ needs.bump-version.outputs.changelog }}"
          else
            PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -z "$PREVIOUS_TAG" ]; then
              CHANGELOG=$(git log --pretty=format:"* %s (%h)" --no-merges)
            else
              CHANGELOG=$(git log --pretty=format:"* %s (%h)" --no-merges "${PREVIOUS_TAG}..HEAD")
            fi
          fi

          {
            echo "CHANGELOG<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Create Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          name: Release v${{ steps.get_version.outputs.version }}
          body: |
            ## Changes in this Release

            ${{ env.CHANGELOG }}

            ## Installation

            ### Install with Go

            ```shell
            go install github.com/sammcj/skint@HEAD
            ```

            ### Download pre-built binaries

            1. Download the binary for your platform:

            - **Linux AMD64**: `skint-linux-amd64`
            - **Linux ARM64**: `skint-linux-arm64`
            - **macOS Apple Silicon**: `skint-darwin-arm64`

            2. Rename the binary to `skint` and place it in your path (e.g., `mv skint-darwin-arm64 ~/.local/bin/skint`).
            3. Make the binary executable: `chmod +x ~/.local/bin/skint`

            On macOS, you may also need to remove the quarantine attribute:
            ```shell
            xattr -r -d com.apple.quarantine ~/.local/bin/skint
            ```

          files: |
            release/skint-linux-amd64
            release/skint-linux-arm64
            release/skint-darwin-arm64
          draft: false
          prerelease: false
          tag_name: ${{ github.ref == 'refs/heads/main' && needs.bump-version.outputs.new_tag || github.ref }}
